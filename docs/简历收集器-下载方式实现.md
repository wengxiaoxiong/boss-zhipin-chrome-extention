# 简历收集器 - 下载方式实现说明

## 更新内容

根据用户需求，简历收集器已更新为**下载方式**，并使用 **IndexedDB** 存储简历信息。

## 核心变更

### 1. 存储方式变更

**之前**：提取PDF文本内容保存到 Chrome Storage
**现在**：点击下载按钮，将简历文件下载到本地，并在 IndexedDB 中记录简历信息

### 2. 数据库实现

使用 **IndexedDB** 替代 SQLite（IndexedDB 是浏览器原生支持的结构化数据库，更适合Chrome扩展）

#### 数据库结构

**数据库名称**: `BossRecruitmentDB`
**表名**: `resumes`

**字段**:
- `id` (自增主键)
- `name` (候选人姓名)
- `timestamp` (收集时间)
- `status` (状态，默认为 'downloaded')

**索引**:
- `name` - 按姓名查询
- `timestamp` - 按时间排序
- `status` - 按状态筛选

### 3. 工作流程

#### 情况2: 对方要发简历（需要同意）

```
1. 检测到消息："对方想发送附件简历给您，您是否同意"
   ↓
2. 点击"同意"按钮
   ↓
3. 等待2秒（简历按钮加载）
   ↓
4. 重新检查状态 → 转到情况3
```

#### 情况3: 已有简历（预览并下载）

```
1. 检测到"点击预览附件简历"按钮
   ↓
2. 点击预览按钮
   ↓
3. 等待3秒（预览窗口加载）
   ↓
4. 查找下载按钮（3种方案）
   方案1: 通过 SVG icon "#icon-attacthment-download"
   方案2: 通过 class ".icon-content" + SVG href
   方案3: 通过文本"下载"
   ↓
5. 点击下载按钮
   ↓
6. 等待1.5秒（下载开始）
   ↓
7. 保存简历信息到 IndexedDB
   {
     name: "候选人姓名",
     timestamp: "2024-12-21T10:00:00.000Z",
     status: "downloaded"
   }
   ↓
8. 关闭预览窗口（查找 .boss-popup__close）
   ↓
9. 继续下一个候选人
```

## 技术实现

### Content Script (content.ts)

#### 主函数: previewAndDownloadResume()

```typescript
async function previewAndDownloadResume(candidateName: string): Promise<boolean> {
  // 1. 点击预览按钮
  // 2. 等待预览窗口
  // 3. 点击下载按钮
  // 4. 保存到数据库
  // 5. 关闭窗口
}
```

#### 下载按钮查找: clickDownloadButton()

使用3种方案确保找到下载按钮：
1. SVG use 元素的 xlink:href 属性
2. .icon-content 容器内的 SVG
3. 文本匹配"下载"

#### 数据库保存: saveResumeInfo()

通过消息传递给 background script：
```typescript
chrome.runtime.sendMessage({
  type: 'SAVE_RESUME_TO_DB',
  data: {
    name: candidateName,
    timestamp: new Date().toISOString(),
    status: 'downloaded'
  }
})
```

### Background Script (background.ts)

#### IndexedDB 操作

**初始化数据库**: `openDatabase()`
- 创建数据库和表
- 创建索引

**保存数据**: `saveResumeToDB()`
- 插入新记录
- 返回自增ID

**查询数据**: `getAllResumes()`
- 获取所有简历记录
- 按时间排序

**清空数据**: `clearAllResumes()`
- 清空所有记录

#### 消息监听

```typescript
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  if (request.type === 'SAVE_RESUME_TO_DB') {
    saveResumeToDB(request.data)
      .then((id) => sendResponse({ success: true, data: { id } }))
      .catch((error) => sendResponse({ success: false, error: error.message }))
    return true
  }
  
  if (request.type === 'GET_ALL_RESUMES') {
    getAllResumes()
      .then((resumes) => sendResponse({ success: true, data: resumes }))
      .catch((error) => sendResponse({ success: false, error: error.message }))
    return true
  }
  
  if (request.type === 'CLEAR_ALL_RESUMES') {
    clearAllResumes()
      .then(() => sendResponse({ success: true }))
      .catch((error) => sendResponse({ success: false, error: error.message }))
    return true
  }
})
```

## 使用说明

### 查看收集的简历信息

在浏览器控制台运行：

```javascript
// 获取所有简历
chrome.runtime.sendMessage(
  { type: 'GET_ALL_RESUMES' },
  (response) => {
    console.log('已收集的简历:', response.data)
  }
)
```

### 导出简历数据

```javascript
chrome.runtime.sendMessage(
  { type: 'GET_ALL_RESUMES' },
  (response) => {
    const resumes = response.data
    const json = JSON.stringify(resumes, null, 2)
    const blob = new Blob([json], { type: 'application/json' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `resumes_${new Date().toISOString()}.json`
    a.click()
  }
)
```

### 清空简历数据

```javascript
chrome.runtime.sendMessage(
  { type: 'CLEAR_ALL_RESUMES' },
  (response) => {
    console.log('简历数据已清空')
  }
)
```

### 查看IndexedDB数据库

1. 打开Chrome开发者工具
2. 选择 **Application** 标签
3. 左侧展开 **IndexedDB** > **BossRecruitmentDB** > **resumes**
4. 可以直接查看、编辑、删除数据

## 优势

1. **结构化存储**: IndexedDB 提供类似SQL的结构化查询能力
2. **大容量**: IndexedDB 没有5MB限制（Chrome Storage的限制）
3. **索引查询**: 支持按姓名、时间、状态快速查询
4. **事务支持**: 保证数据一致性
5. **浏览器原生**: 不需要额外依赖

## 注意事项

1. **下载位置**: 简历文件下载到浏览器默认下载目录
2. **文件命名**: 由BOSS直聘页面决定（通常是"候选人姓名 简历.pdf"）
3. **数据持久化**: IndexedDB数据会永久保存，除非手动清空或卸载扩展
4. **跨域限制**: IndexedDB数据仅在扩展内部可访问

## 下载按钮定位策略

由于BOSS直聘页面可能更新，我们使用了3种策略来定位下载按钮：

### 策略1: SVG图标ID
```html
<use xlink:href="#icon-attacthment-download"></use>
```

### 策略2: class + SVG检查
```html
<div class="icon-content">
  <svg class="boss-svg">
    <use href="...download..."></use>
  </svg>
</div>
```

### 策略3: 文本匹配
查找textContent为"下载"的按钮或链接元素

## 调试日志

所有操作都有详细的控制台日志：

- `[Resume Collector]` - 简历收集器主流程
- `[DB]` - 数据库操作
- 每个步骤都有 ✅ 成功 或 ❌ 失败 标记

## 故障排查

### 下载按钮找不到
- 检查控制台日志，查看尝试了哪些策略
- 手动检查预览窗口的HTML结构
- 可能需要增加等待时间

### 数据库保存失败
- 检查 background script 的日志
- 检查 IndexedDB 是否被禁用
- 尝试清空数据库重新开始

### 预览窗口关闭失败
- 检查是否有 `.boss-popup__close` 元素
- 可能需要更新选择器



